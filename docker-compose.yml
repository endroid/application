version: '3.8'
services:
    fusionauth:
        image: fusionauth/fusionauth-app:1.43.0
        environment:
            DATABASE_URL: jdbc:postgresql://postgres:5432/fusionauth
            DATABASE_ROOT_USERNAME: root
            DATABASE_ROOT_PASSWORD: root
            DATABASE_USERNAME: fusionauth
            DATABASE_PASSWORD: fusionauth
            FUSIONAUTH_APP_RUNTIME_MODE: development
            FUSIONAUTH_APP_KICKSTART_FILE: /usr/local/fusionauth/kickstart/kickstart.json
        volumes:
            - ./.docker/fusionauth/kickstart:/usr/local/fusionauth/kickstart
        depends_on:
            - postgres
        ports:
            - '9011:9011'

    nginx:
        image: ghcr.io/endroid/docker-nginx:latest
        volumes:
            - .:/var/www/html
            - ~/.letsencrypt:/etc/letsencrypt
        depends_on:
            - node
            - php
        ports:
            - '80:80'
            - '443:443'
            - '3000:3000'
            - '5000:5000'
            - '8000:8000'
            - '9000:9000'
            - '9100:9100'
            - '9200:9200'

    php:
        image: ghcr.io/endroid/docker-php:latest
        volumes:
            - .:/var/www/html
            - ~/.composer:/home/www-data/.composer
            - ~/.gitconfig:/home/www-data/.gitconfig
            - ~/.gitignore_global:/home/www-data/.gitignore_global
            - ~/.ssh:/home/www-data/.ssh
        depends_on:
            - postgres
            - redis
        expose:
            - 9000
        ports:
            - '6001:6000'

    node:
        image: ghcr.io/endroid/docker-node:latest
        tty: true
        environment:
            NODE_ENV: development
        volumes:
            - .:/app
            - ~/.gitconfig:/home/node/.gitconfig
            - ~/.npm:/home/node/.npm
        depends_on:
            - postgres
            - redis
        ports:
            - '3001:3000'
            - '5173:5173'

    python:
        image: ghcr.io/endroid/docker-python:latest
        tty: true
        volumes:
            - .:/app
            - ~/.gitconfig:/home/python/.gitconfig
        ports:
            - '5001:5000'

    rust:
        image: ghcr.io/endroid/docker-rust:latest
        tty: true
        volumes:
            - .:/app
            - ~/.gitconfig:/home/rust/.gitconfig
        expose:
            - '8001:8000'

    redis:
        image: redis:7.0.5
        volumes:
            - .docker/redis/data:/data
        expose:
            - 6379

    postgres:
        image: postgres:15.1
        environment:
            POSTGRES_DB: nestjs
            POSTGRES_USER: root
            POSTGRES_PASSWORD: root
        volumes:
            - .docker/postgres/data:/var/lib/postgresql/data
        ports:
            - '5432:5432'

    blackfire:
        image: blackfire/blackfire:2
        environment:
            # Do not change: instead set these envs on your host
            BLACKFIRE_SERVER_ID: ~
            BLACKFIRE_SERVER_TOKEN: ~
            BLACKFIRE_CLIENT_ID: ~
            BLACKFIRE_CLIENT_TOKEN: ~
