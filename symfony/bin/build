#!/bin/bash

set -ex

cd "$(dirname "$0")"/..

rm -rf application

composer create-project symfony/skeleton:^6.0 application --no-interaction

(
    cd application

    composer config minimum-stability dev
    composer config prefer-stable true
    composer config extra.symfony.allow-contrib true
    composer config platform.php 8.1

    cp -r ../base/. ./

    composer require \
        php:^8.1 \
        api-platform/api-pack \
        doctrine/doctrine-fixtures-bundle \
        knplabs/knp-snappy-bundle \
        predis/predis \
        runtime/roadrunner-symfony-nyholm:dev-main \
        symfony/messenger:* \
        symfony/phpunit-bridge:* \
        symfony/uid:* \
        webapp \
        webonyx/graphql-php \
        --no-update --with-all-dependencies --no-interaction

    composer require \
        roave/security-advisories:dev-latest \
        --dev --no-update --no-interaction

    composer update --no-interaction

    bin/console doctrine:database:drop --if-exists --force
    bin/console doctrine:database:create
    bin/console doctrine:migrations:diff

    bin/setup

    bin/console doctrine:fixtures:load --no-interaction

    git init
    git add -A && git commit -m "Initial commit"
)
